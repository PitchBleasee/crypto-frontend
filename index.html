
<!DOCTYPE html>
<html>
<head>
    <title>Crypto AI Assistant</title>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 20px; }
        input, button { padding: 8px; margin: 5px; }
        #results, #volatile, #batchResults { background: #fff; padding: 15px; margin-top: 10px; border-radius: 8px; }
        h2 { margin-bottom: 0; }
        pre { background: #eee; padding: 10px; overflow-x: auto; }
        canvas { max-width: 100%; margin-top: 15px; }
    </style>
</head>
<body>
    <h1>Crypto AI Assistant</h1>
    <div>
        <input id="symbol" placeholder="Enter crypto symbol (e.g. bitcoin)">
        <button onclick="analyze()">Analyze</button>
        <button onclick="analyzeTopVolatile()">Analyze Top Volatile</button>
    </div>

    <div id="results"></div>
    <canvas id="priceChart" width="400" height="200"></canvas>
    <div id="batchResults"></div>
    <div id="volatile"></div>

    <script>
        let chartInstance;

        async function analyze() {
            const symbol = document.getElementById('symbol').value;
            const res = await fetch(`/analyze?symbol=${symbol}`);
            const data = await res.json();

            document.getElementById('results').innerHTML = `
                <h2>Analysis for ${data.symbol}</h2>
                <p><strong>Price:</strong> $${data.price}</p>
                <p><strong>RSI:</strong> ${data.rsi}</p>
                <p><strong>MACD:</strong> ${data.macd}</p>
                <p><strong>Signal:</strong> ${data.signal}</p>
                <p><strong>SMA:</strong> ${data.sma}</p>
                <p><strong>EMA:</strong> ${data.ema}</p>
                <p><strong>Support:</strong> ${data.support}</p>
                <p><strong>Resistance:</strong> ${data.resistance}</p>
                <h3>GPT Summary</h3>
                <pre>${data.gpt_summary}</pre>
                <h3>News</h3>
                <ul>${data.news.map(n => `<li><a href="${n.url}" target="_blank">${n.title}</a> (${n.source})</li>`).join("")}</ul>
            `;

            drawChart(data.history.dates, data.history.prices, data.history.sma, data.history.bb_upper, data.history.bb_lower);
        }

        function drawChart(dates, prices, sma, upperBand, lowerBand) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Close Price',
                            data: prices,
                            borderColor: 'black',
                            borderWidth: 1,
                            fill: false
                        },
                        {
                            label: 'SMA',
                            data: sma,
                            borderColor: 'blue',
                            borderWidth: 1,
                            fill: false
                        },
                        {
                            label: 'Bollinger Upper',
                            data: upperBand,
                            borderColor: 'green',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false
                        },
                        {
                            label: 'Bollinger Lower',
                            data: lowerBand,
                            borderColor: 'red',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { display: true },
                        y: { display: true }
                    }
                }
            });
        }

        async function getVolatile() {
            const res = await fetch('/market-scan');
            const data = await res.json();

            document.getElementById('volatile').innerHTML = `
                <h2>Top Volatile Coins</h2>
                <ul>${data.top_volatile.map(c => `<li>${c.name} (${c.symbol.toUpperCase()}): ${c.volatility_score.toFixed(2)}%</li>`).join("")}</ul>
            `;
        }

        async function analyzeTopVolatile() {
            const res = await fetch('/analyze-multi');
            const data = await res.json();

            document.getElementById('batchResults').innerHTML = `
                <h2>Top Volatile Crypto Analyses</h2>
                ${data.analysis.map(d => d.error ? 
                `<div><h3>${d.symbol.toUpperCase()}</h3><p style="color:red;">Error: ${d.error}</p></div>` :
                `<div><h3>${d.symbol.toUpperCase()}</h3>
                    <p><strong>Price:</strong> $${d.price}</p>
                    <p><strong>RSI:</strong> ${d.rsi}</p>
                    <p><strong>MACD:</strong> ${d.macd}</p>
                    <p><strong>Signal:</strong> ${d.signal}</p>
                    <p><strong>SMA:</strong> ${d.sma}</p>
                    <p><strong>EMA:</strong> ${d.ema}</p>
                    <p><strong>Support:</strong> ${d.support}</p>
                    <p><strong>Resistance:</strong> ${d.resistance}</p>
                    <h4>GPT Summary</h4>
                    <pre>${d.gpt_summary}</pre>
                    <h4>News</h4>
                    <ul>${d.news.map(n => `<li><a href="${n.url}" target="_blank">${n.title}</a> (${n.source})</li>`).join("")}</ul>
                </div>`).join("")}
            `;
        }

        getVolatile();
    </script>
</body>
</html>
